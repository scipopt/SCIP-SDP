\documentclass[10pt, a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[american]{babel}
\usepackage[dvipsnames]{xcolor}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{dsfont}
\usepackage{mathtools}
\usepackage{graphicx}
\usepackage{enumitem}
\usepackage{booktabs}
\usepackage{siunitx}
\usepackage[lined,ruled,noend,linesnumbered]{algorithm2e}
\usepackage[color=red!50!blue!50,textsize=footnotesize,textwidth=4cm]{todonotes}
\usepackage[breaklinks,colorlinks,citecolor=blue,linkcolor=blue]{hyperref}
% \usepackage[tmargin=2.5cm,bmargin=2.5cm,lmargin=2.8cm,rmargin=2.8cm]{geometry}
\usepackage{cleveref}
\usepackage{xspace}

% operators
\DeclareMathOperator{\conv}{conv}
\DeclareMathOperator{\cone}{cone}
\DeclareMathOperator{\aff}{aff}
\DeclareMathOperator{\lin}{lin}
\DeclareMathOperator*{\argmin}{argmin}
\DeclareMathOperator*{\argmax}{argmax}
\DeclareMathOperator{\supp}{supp}
\DeclareMathOperator{\relint}{relint}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\Diag}{Diag}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\tr}{tr}
\renewcommand{\Re}{\text{Re}}

% macros
\newcommand{\suchthat}{\,:\,}
\newcommand{\abs}[1]{\lvert{#1}\rvert}
\newcommand{\card}[1]{\lvert{#1}\rvert}
\newcommand{\ceil}[1]{\lceil{#1}\rceil}
\newcommand{\floor}[1]{\lfloor{#1}\rfloor}
\newcommand{\define}{\coloneqq}
\newcommand{\enifed}{\eqqcolon}
\newcommand{\norm}[1]{\lVert{#1}\rVert}
\newcommand{\Norm}[2]{\lVert{#1}\rVert_{#2}}
\newcommand{\skal}[2]{\langle{#1},{#2}\rangle}
\newcommand{\order}[1]{O\left({#1}\right)}
\newcommand{\T}{^{\top}}

% sets
\newcommand{\R}{\mathds{R}}
\newcommand{\Z}{\mathds{Z}}
\newcommand{\Q}{\mathds{Q}}
\newcommand{\N}{\mathds{N}}
\newcommand{\C}{\mathds{C}}
\newcommand{\E}{\mathds{E}}
\newcommand{\ones}{\mathds{1}}
\renewcommand{\P}{\mathds{P}}
\renewcommand{\E}{\mathds{E}}

% environments
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{observation}[theorem]{Observation}
\newtheorem{example}[theorem]{Example}
\newtheorem{question}[theorem]{Question}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{assumption}[theorem]{Assumption}

% adjust itemize
\setlist[itemize]{topsep=0.5ex,partopsep=0ex,parsep=0ex,itemsep=0.5ex}

% other defines
\newcommand{\MP}[1]{\todo{#1}}
\newcommand{\MPin}[1]{\todo[inline]{#1}}


% title
\title{Conflict Analysis for Mixed-integer SDPs}
\author{Marc E. Pfetsch\thanks{Department of Mathematics, TU Darmstadt, Germany}}
\date{June 2022}

% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
\begin{document}

\maketitle

The original intention of conflict analysis was to derive useful
information from infeasible subproblems in a branch-and-bound
procedure. There are two types of conflict analysis:
\begin{itemize}
\item If infeasibility was determined using propagation of variable bounds,
  one can use a graph-based conflict analysis. Here, a directed graph
  encodes the dependency of bound changes on each other, i.e., whether one
  bound was used to strengthen the other bound. One can then try to find a
  small subset of bound changes that arise from branching decisions that
  still lead to infeasibility. One can then add constraints that enforce
  that at least one branching decision is taken in a different
  way. See~\cite{Ach07b,Ach07} for more information in the context of MIPs.

  This kind of conflict analysis can also be used in the context of MISDPs
  and has already been investigated in~\cite{MatP22}. Overall, this kind of
  conflict analysis was not beneficial.
\item If the relaxation is infeasible, there are two ways to derive
  conflict information: The first is a greedy approach, which relaxes some
  of the branching decisions leading to the current relaxation as long as
  the relaxation remains infeasible. Then a constraint as in graph-based
  conflict analysis can be derived. See~\cite{Ach07b,Ach07} for more
  information in the context of MIPs.

  The other method is to use dual information to derive valid inequalities,
  which can then be propagated during the tree. This is called dual ray
  analysis by Witzig~\cite{Wit22} (see also \cite{WitBH17}). We follow this
  approach in the following.
\end{itemize}

Very similar ideas are needed for an outer approximation algorithm, in
which one adds aggregated inequalities that will cut off nodes that are
infeasible or bound exceeding. Coey et al.~\cite{CoeLV20} describe such an
algorithm for mixed-integer conic problems (including MISDP).



% -------------------------------------------------------------------------
\section{Introduction}

We consider mixed-integer SDPs of the following form:
\begin{equation}\label{MISDP}
  \begin{aligned}
    \inf \quad & b\T y \\
    \text{s.t.} \quad & \sum_{j=1}^m A^j\, y_j - A^0 \succeq 0, \\
    & D y \geq d,\\
    & \ell \leq y \leq u,\\
    & y_i \in \Z,\quad i \in I.
  \end{aligned}
\end{equation}
In each node, we solve the following relaxations with local bounds $\ell$
and $u$:
\begin{equation}\label{SDP-D}
  \begin{aligned}
    \inf \quad & b\T y \\
    \text{s.t.} \quad & \sum_{j=1}^m A^j\, y_j - A^0 \succeq 0, \\
    & D y \geq d,\\
    & \ell \leq y \leq u,
  \end{aligned}
\end{equation}
where for simplicity of exposition, we assume that all entries of $\ell$
and $u$ are finite. Moreover, we always assume that $\ell \leq u$ holds.

The general idea of conflict analysis is to generate globally valid
constraints as follows. Let any $\hat{X} \succeq 0$ and $\hat{z} \geq 0$ be
given. Then because $A(y) \define \sum_{j=1}^m A^j\, y_j - A^0$ is positive
semidefinite for all feasible $y \in \R^m$, we have
$\skal{A(y)}{\hat{X}} \geq 0$.  Similarly, the aggregated inequalities
$\hat{z}\T D y \geq \hat{z}\T d$ hold. Together this yields:
\begin{align}
  & \skal{A(y)}{\hat{X}} + \hat{z}\T D y \geq \hat{z}\T d\notag\\
  \Leftrightarrow\quad
  & \sum_{j=1}^m \skal{A^j}{\hat{X}} y_j + \hat{z}\T D y \geq
    \skal{A^0}{\hat{X}} + \hat{z}\T d,\label{eq:ConflictCut}
\end{align}
which is valid for all feasible $y$. Clearly,
Inequality~\eqref{eq:ConflictCut} is redundant for continuous $y$, but it
might allow to cut off certain mixed-integer solutions~$y$. In the implementation,
we only propagate bounds using~\eqref{eq:ConflictCut}.


More generally, we can also use the variable bounds $\ell \leq y$ and
$y \leq u$. If $\hat{r}^\ell$, $\hat{r}^u \geq 0$ are the corresponding
multiliers, this yields:
\begin{align}
  & \skal{A(y)}{\hat{X}} + \hat{z}\T D y + (\hat{r}^\ell)\T y - (\hat{r}^u)\T y
    \geq \hat{z}\T d + (\hat{r}^\ell)\T \ell + (\hat{r}^u)\T u\notag\\
  \Leftrightarrow\quad
  & \sum_{j=1}^m \skal{A^j}{\hat{X}} y_j + \hat{z}\T D y +
    (\hat{r}^\ell)\T y - (\hat{r}^u)\T y \geq \\
  & \qquad \skal{A^0}{\hat{X}} +
    \hat{z}\T d + (\hat{r}^\ell)\T \ell + (\hat{r}^u)\T u,\label{eq:ConflictCut2}
\end{align}
which is again valid for all feasible $y$.

It seems that~\eqref{eq:ConflictCut2} are less helpful
than~\eqref{eq:ConflictCut}. However, one can cancel some coefficients
in~\eqref{eq:ConflictCut} using variable bounds -- see
Section~\ref{sec:Canceling}.


% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
\section{Generation of Conflict Constraints}

% -------------------------------------------------------------------------
\subsection{Feasible Problems}

Let $X$ be the dual variables for the SDP-constraint $A(y) \succeq 0$, $z$
be the dual variables for $Dy \geq d$, and $r^\ell$ and $r^u$ be the dual
variables for the bound constraints $y \geq \ell$ and $-y \geq -u$,
respectively. Then the corresponding primal problem for~\eqref{SDP-D} is:
\begin{equation}\label{SDP-P}
  \begin{aligned}
     \sup \quad & \skal{A^0}{X} + z\T d + \ell\T r^\ell - u\T r^u\\
     \text{s.t.} \quad & \skal{A^j}{X} + (D\T z)_j + r^\ell_j - r^u_j = b_j && \forall \, j \in [m],\\
     & X \succeq 0,\; z, \; r^\ell,\; r^u \geq 0.
  \end{aligned}
\end{equation}
Any feasible solution $(\hat{X}, \hat{z}, \hat{r}^\ell, \hat{r}^u)$ can be
used to construct~\eqref{eq:ConflictCut} or~\eqref{eq:ConflictCut2}.

Moreover, one can take an objective cutoff into account. Namely, assume
that $y^\star$ is a feasible solution to~\eqref{MISDP}. We are then only
interested in solutions that are at least as good, i.e.,
$b\T y \leq b\T y^\star$ or $- b\T y \geq - b\T y^\star$. Adding this
inequality to~\eqref{eq:ConflictCut} yields:
\begin{align*}
  & \sum_{j=1}^m \skal{A^j}{\hat{X}} y_j + \hat{z}\T D y - b\T y \geq
    \skal{A^0}{\hat{X}} + \hat{z}\T d - b\T y^\star\\
  \Leftrightarrow\quad
  & \sum_{j=1}^m \big(\skal{A^j}{\hat{X}} + (\hat{z}\T D)_j - b_j\big) y_j \geq
    \skal{A^0}{\hat{X}} + \hat{z}\T d - b\T y^\star.
\end{align*}

% -------------------------------------------------------------------------
\subsection{Infeasible Problems}

Similarly, a primal ray $(\hat{X}, \hat{z}, \hat{r}^\ell, \hat{r}^u)$,
i.e., it satsifies the system
\begin{equation}\label{eq:ray}
\begin{aligned}
  & \skal{A^j}{X} + (D\T z)_j + r^\ell_j - r^u_j = 0 && \forall\; j \in [m],\\
  & \skal{A^0}{X} + d\T z + \ell\T r^\ell - u\T r^u > 0,
\end{aligned}
\end{equation}
yields an inequality as in~\eqref{eq:ConflictCut}
or~\eqref{eq:ConflictCut2}.

In this case, one can prove that~\eqref{eq:ConflictCut} actually proves
infeasibility for the local bounds~$\ell$ and $u$. To this end, we first
show the following:

\begin{lemma}\label{lemma:ComplemenatrySolution}
  If~\eqref{eq:ray} has a feasible solution, then there exists a feasible
  solution in which $r_j^\ell \cdot r_j^u = 0$ for all $j \in [m]$, i.e.,
  at most one of $r_j^\ell$ and $r_j^u$ is nonzero.
\end{lemma}

\begin{proof}
  Let $(\hat{X}, \hat{z}, \tilde{r}^\ell, \tilde{r}^u)$ be a feasible
  solution of~\eqref{eq:ray}. Then define
  \[
    \hat{r}^\ell_j \define - \min\,\{\skal{A^j}{\hat{X}} + (D\T \hat{z})_j,\; 0\} \geq 0,
    \quad
    \hat{r}^u_j = \max\,\{\skal{A^j}{\hat{X}} + (D\T \hat{z})_j,\; 0\} \geq 0.
  \]
  We claim that $(\hat{X}, \hat{z}, \hat{r}^\ell, \hat{r}^u)$ is feasible
  for~\eqref{eq:ray}. Note that by construction we have
  $\hat{r}^\ell_j \cdot \hat{r}^u_j = 0$ for all $j \in [m]$.

  First observere that the equations of~\eqref{eq:ray} are
  satisfied. Therefore consider the contribution to
  $\ell\T \hat{r}^\ell - u\T \hat{r}^u$ in component $j$:
  \begin{align*}
    \ell_j \hat{r}^\ell_j - u_j \hat{r}^u_j & = - \ell_j\, \min\,\{\skal{A^j}{\hat{X}} + (D\T \hat{z})_j, 0\} - u_j\, \max\,\{\skal{A^j}{\hat{X}} + (D\T \hat{z})_j, 0\}\\
    & = - \ell_j\, \min\,\{\tilde{r}^u_j - \tilde{r}^\ell_j, 0\} - u_j\, \max\,\{\tilde{r}^u_j - \tilde{r}^\ell_j, 0\}\\
    & = \begin{cases}
      - \ell_j\, (\tilde{r}^u_j - \tilde{r}^\ell_j) & \text{if } \tilde{r}^u_j - \tilde{r}^\ell_j < 0,\\
      - u_j\, (\tilde{r}^u_j - \tilde{r}^\ell_j) & \text{if } \tilde{r}^u_j - \tilde{r}^\ell_j \geq 0,
    \end{cases}\\
    & = \begin{cases}
      - \ell_j\, \tilde{r}^u_j + \ell_j \tilde{r}^\ell_j & \text{if } \tilde{r}^u_j - \tilde{r}^\ell_j < 0,\\
      - u_j\, \tilde{r}^u_j + u_j \tilde{r}^\ell_j & \text{if } \tilde{r}^u_j - \tilde{r}^\ell_j \geq 0,
    \end{cases}\\
    & \geq \begin{cases}
      - u_j\, \tilde{r}^u_j + \ell_j \tilde{r}^\ell_j & \text{if }  \tilde{r}^u_j - \tilde{r}^\ell_j < 0,\\
      - u_j\, \tilde{r}^u_j + \ell_j \tilde{r}^\ell_j & \text{if } \tilde{r}^u_j - \tilde{r}^\ell_j \geq 0,
    \end{cases}\\
    & = \ell_j \tilde{r}^\ell_j - u_j \tilde{r}^u_j.
  \end{align*}
  Therefore the inequality in~\eqref{eq:ray} holds as well.
\end{proof}

\begin{proposition}
  Let $(\hat{X}, \hat{z})$ be part of a solution of~\eqref{eq:ray}. Then~\eqref{eq:ConflictCut}, i.e.,
  \[
    \skal{A(y)}{\hat{X}} + \hat{z}\T D \geq \hat{z}\T d
  \]
  is infeasible with respect to the local bounds $\ell$ and $u$.
\end{proposition}

\begin{proof}
  One the one hand, any feasible solution $\hat{y}$ of~\eqref{MISDP} satisfies
  $A(\hat{y}) \succeq 0$, $D \hat{y} \geq d$, and
  $\ell \leq \hat{y} \leq u$. Defining
  $\hat{s}_j \define \skal{A^j}{\hat{X}} + (\hat{z}\T D)_j$ for
  $j \in [m]$, we get from~\eqref{eq:ConflictCut}:
  \begin{align*}
    \skal{A^0}{\hat{X}} + \hat{z}\T d & \leq \sum_{j=1}^m \big(\skal{A^j}{\hat{X}} + (\hat{z}\T D)_j\big)\, \hat{y}_j
    = \sum_{j=1}^m \hat{s}_j\, \hat{y}_j\\
    & \leq \sum_{j: \hat{s}_j < 0} \hat{s}_j\, \ell_j +
        \sum_{j: \hat{s}_j > 0} \hat{s}_j\, u_j.
  \end{align*}

  On the other hand let $(\hat{X}, \hat{z}, \hat{r}^\ell, \hat{r}^u)$ be a
  feasible solution of~\eqref{eq:ray} that satisfies the conditions of
  Lemma~\ref{lemma:ComplemenatrySolution}. Then
  $\hat{r}^u - \hat{r}^\ell = \hat{s}$.  We thus obtain
  \begin{align*}
    0 & < \skal{A^0}{\hat{X}} + d\T \hat{z} + \ell\T \hat{r}^\ell - u\T \hat{r}^u\\
      & = \skal{A^0}{\hat{X}} + d\T \hat{z} + \sum_{j=1}^m \ell_j \hat{r}^\ell_j -
        \sum_{j=1}^m u_j \hat{r}^u_j\\
      & = \skal{A^0}{\hat{X}}  + d\T \hat{z} - \sum_{j: \hat{s}_j < 0} \ell_j\, \hat{s}_j -
        \sum_{j: \hat{s}_j > 0} u_j\, \hat{s}_j,
  \end{align*}
  a contradition.
\end{proof}

% -------------------------------------------------------------------------
\subsection{Canceling}
\label{sec:Canceling}

Starting from~\eqref{eq:ConflictCut}, one can possibly cancel coefficients
as follows. Again using
$s_j \define \skal{A^j}{\hat{X}} + (\hat{z}\T D)_j$, we get
from~\eqref{eq:ConflictCut}:
\begin{equation}\label{eq:ConflictCut3}
  \sum_{j=1}^m s_j\, y_j \geq \skal{A^0}{\hat{X}} + \hat{z}\T d.
\end{equation}

Assume that $s_j < 0$ for some $j \in [m]$ and the global lower bound of
$y_j$ is at least 0. Then we can add the valid inequality $-s_j\, y_j \geq 0$
to~\eqref{eq:ConflictCut3}, which eliminates variable~$y_j$ from the
inequality. Similarly, if $s_j > 0$ for some $j \in [m]$ and the global
upper bound of $y_j$ is at most 0, we can add $s_j\, y_j \leq 0$ to
eliminate variable~$y_j$.

Witzig et al.~\cite{WitBH17} (see also Witzig~\cite{Wit22}) applied
cancelation to continuous variables, but restricts attention to variables
that are at their global bounds at the node at which the constraint is
generated.


\begin{small}
   \bibliographystyle{plain}
   \bibliography{ConflictAnalysis.bib}
\end{small}

\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
